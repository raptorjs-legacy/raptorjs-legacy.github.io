define("raptor/listeners",["raptor"],function(e,t){"use strict";function y(e,t,r,i){var s=this,o,u;if(typeof e=="object")return i=r,r=t,o={},n(e,function(e,t){o[e]=s.subscribe(e,t,r,i)}),u={unsubscribe:p(o)},u.remove=u.removeAll=u.unsubscribe,u;m(e,s);var a=s._byName[e];return a||(s._byName[e]=a=new v,a.onEmpty(function(){delete s._byName[e]})),a.add(t,r,i)}var n=e.forEachEntry,r=Array.isArray,i=e.extend,s=0,o="__lstnrs",u=function(){},a,f=function(e,t){return e?t?function(){e.apply(t,arguments)}:e:u},l=function(e){var t=[],n;e._listeners.forEach(function(e){e.removed?(n=e.thisObj)&&delete n[o][e.id]:t.push(e)}),e._listeners=t,e._listeners.length||e._onEmpty()},c=function(e,t){t.removed=!0,l(e)},h=function(e,t){return function(){c(e,t)}},p=function(t){return function(r){if(!arguments.length)n(t,function(e,t){t.remove()});else{var i=t[r];if(!i)throw e.createError(new Error("Invalid message name: "+r));i.unsubscribe()}}},d=function(e,t){this.name=e,this.data=t};d.prototype={getName:function(){return this.name},getData:function(){return this.data}};var v=function(){this._listeners=[],this._onEmpty=u};v.prototype={add:function(e,t,n){var r=this,i,u={callback:e,thisObj:t,removed:!1,autoRemove:n,id:s++},a;i=u.remove=h(r,u),r._listeners.push(u);var f={remove:i};return f.unsubscribe=f.remove,t&&((a=t[o])||(a=t[o]={}),a[u.id]=f),f},publish:function(){var e=arguments,t=this;t._listeners.forEach(function(n){if(n.removed)return;n.callback.apply(n.thisObj,e),n.autoRemove&&c(t,n)})},onEmpty:function(e,t){this._onEmpty=f(e,t)},removeAll:function(){var e=this._listeners;for(var t=0;t<e.length;t++)e[t].removed=!0;l(this)},removeObserver:function(e){var t=this._listeners;for(var n=0;n<t.length;n++){var r=t[n];r.thisObj===e&&(r.removed=!0)}l(this)}};var m=function(e,t){var n=t._allowed;if(n&&!n[e])throw new Error('Invalid message name of "'+e+'". Allowed messages: '+Object.keys(n).join(", "))},g=function(e){return function(t){var n=[e].concat(Array.prototype.slice.call(arguments));this[typeof t=="function"?"subscribe":"publish"].apply(this,n)}},b=function(){this._byName||(this._byName={})};return b.prototype={__observable:!0,registerMessages:function(e,t){this._allowed||(this._allowed={});for(var n=0,r=e.length;n<r;n++){var i=e[n];this._allowed[i]=!0,t&&(this[i]=g(i))}},subscribe:y,on:y,unsubscribeAll:function(){n(this._byName,function(e,t){t.removeAll()}),this._byName={}},unsubscribeObserver:function(e){n(this._byName,function(t,n){n.removeObserver(e)})},publish:function(e,t){var n;r(t)?n=t:(a.isMessage(e)?(t=e,e=t.getName()):t=a.createMessage(e,t),n=[t.data,t]),m(e,this);var i=this,s=function(e){var t=i._byName[e];if(!t)return;t.publish.apply(t,n)};s(e),s("*");var o=e.lastIndexOf(".");return o>=0&&s(e.substring(0,o+1)+"*"),t}},a={Message:d,createListeners:function(){return new v},createObservable:function(e,t){var n=new b;return e&&n.registerMessages(e,t),n},makeObservable:function(e,t,n,r){t||(t=e),t.__observable||i(t,b.prototype),b.call(e),n&&e.registerMessages(n,r)},isObervable:function(e){return e&&e.__observable},createMessage:function(e,t){return new d(e,t)},isMessage:function(e){return e instanceof d},bind:f,unsubscribeFromAll:function(e){var t=e[o];if(t)for(var n in t)t[n].unsubscribe()}},a});