define.extend("raptor/widgets",function(e,t){"use strict";var n=e("raptor/logging").logger("raptor/widgets"),r={},i=e("raptor"),s=Array.isArray,o=i.createError,u=e("raptor/widgets/Widget"),a=function(e){var t={};return i.forEach(e,function(e){t[e[0]]={target:e[1],props:e[2]}},this),t},f=function(){};f.prototype={_remove:function(e,t){var n=this[t];s(n)?this[t]=n.filter(function(t){return t!==e}):delete this[t]},_add:function(e,t,n){var r=this[t];r?s(r)?r.push(e):this[t]=[r,e]:this[t]=n?[e]:e},getWidget:function(e){return this[e]},getWidgets:function(e){var t=this[e];return t?s(t)?t:[t]:[]}};var l=function(i,s,l,c,h,p,d,v){if(!e.exists(i))throw o(new Error('Unable to initialize widget of type "'+i+'". The class for the widget was not found.'));var m,g=e(i);n.debug('Creating widget of type "'+i+'" ('+s+")");if(g.initWidget)c.elId=s,c.events=p,m=g,g.onReady||(g.onReady=t.onReady);else{var y=function(){},b;y.prototype=b=g.prototype,m=new y,u.makeWidget(m,b),m.registerMessages(["beforeDestroy","destroy"],!1);var w=b.events||g.events;w&&m.registerMessages(w,!1),s&&(m._id=s,m.el=m.getEl()),g.getName||(g.getName=function(){return i}),b.constructor=g,u.legacy&&(m._parentWidget=d),p&&(m._events=a(p)),m.widgets=new f,r[s]=m;if(l&&h){var E;l.endsWith("[]")&&(l=l.slice(0,-2),E=!0),m._assignedId=l,m._scope=h;var S=r[h];if(!S)throw o(new Error("Parent scope not found: "+h));S.widgets._add(m,l,E),u.legacy&&(S[l]=m)}}return{widget:m,init:function(){var e=function(){try{m.initWidget?m.initWidget(c):g.call(m,c)}catch(e){var t='Unable to initialize widget of type "'+i+"'. Exception: "+e;if(!v)throw e;n.error(t,e)}};m.initBeforeOnDomReady===!0?e():m.onReady(e)}}};return e("raptor/pubsub").subscribe({"dom/beforeRemove":function(e){var n=e.el,r=t.get(n.id);r&&r.destroy({removeNode:!1,recursive:!0})},"raptor/renderer/renderedToDOM":function(e){var n=e.context,r=t.getWidgetsContext(n);r.initWidgets()}}),{initWidget:function(e){var t=l(e.type,e.id,e.assignedId,e.config,e.scope?e.scope.id:null,e.events);e.widget=t.widget,e.children.length&&e.children.forEach(this.initWidget,this),t.init()},_serverInit:function(e){var t=function(e,n){if(!e)return;var r=0,i=e.length;for(;r<i;r++){var s=e[r],o=s[0],u=s[1],a=s[2]||{},f=s[3],c=s[4],h=s[5]||{},p=s.slice(6);f===0&&(f=undefined),c===0&&(c=undefined),a===0&&(a=undefined);var d=l(o,u,c,a,f,h,n,1);p&&p.length&&t(p,d.widget),d.init()}};t(e)},get:function(e){return r[e]},_remove:function(e){delete r[e]}}}),$rwidgets=function(){require("raptor/widgets")._serverInit(require("raptor").arrayFromArguments(arguments))};